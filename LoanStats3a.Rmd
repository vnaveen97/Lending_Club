---
title: "Lending_club"
author: "Naveen"
date: "10/10/2020"
output: html_document
---
Loading the required packages

```{r packages, message=FALSE}
packs = c('dplyr','ggplot2', 'caret','corrplot', 'e1071','readr','RANN', 'stringr', 'qdapRegex')
lapply(packs,require,character.only=TRUE)
```


```{r dataset, message=FALSE}
dataset = read_csv('LoanStats3a.csv')
#View(dataset)
```


```{r XY}
Y       = select(dataset,Approved) %>% unlist()
X       = select(dataset,-c(Approved,id,member_id,emp_title,url:addr_state,
                 earliest_cr_line,issue_d,next_pymnt_d,last_credit_pull_d,last_pymnt_d))
```



term, grade, sub_grade, home_ownership, verification_status, loan_status, pymnt_plan, purpose, addr_state are the categorical variables found from the dataset.

```{r}
ggplot_missing <- function(x){
    if(!require(reshape2)){warning('you need to install reshape2')}
    require(reshape2)
    require(ggplot2)
    #### This function produces a plot of the missing data pattern
    #### in x.  It is a modified version of a function in the 'neato' package
  
  x %>% 
    is.na %>%
    melt %>%
    ggplot(data = .,
           aes(x = Var2,
               y = Var1)) +
    geom_raster(aes(fill = value)) +
    scale_fill_grey(name = "",
                    labels = c("Present","Missing")) +
    theme_minimal() + 
    theme(axis.text.x  = element_text(angle=45, vjust=0.5)) + 
    labs(x = "Variables in Dataset",
         y = "Rows / observations")
}
ggplot_missing(X)
```
Visual plot is not useful. Calculating the percentages of missing values for each feature.
```{r, missing_percent, cache=TRUE}
missingPercent = colMeans(is.na.data.frame(X))
```

Removing features which contain more than 60% of missing values

```{r, cache=TRUE}
X1 = select(X, -c(mths_since_last_delinq,mths_since_last_record,mths_since_last_major_derog,annual_inc_joint,dti_joint,
                verification_status_joint,tot_coll_amt:bc_util,mo_sin_rcnt_rev_tl_op:percent_bc_gt_75,tot_hi_cred_lim:total_il_high_credit_limit,
                initial_list_status,policy_code,application_type,mo_sin_old_rev_tl_op,mo_sin_old_il_acct))

# X %>% filter(colMeans(is.na.data.frame(X)) < 0.4)
```

Using regex functions splitting the number of months and string month from features


```{r}
X2 = X1 %>% mutate(term = sub(" m.*","",term), revol_util = sub("%","",revol_util), int_rate = sub("%","",int_rate))

#Counting the number of unique values in each feature to see if there are any categorical features.

print(str(X2))

sapply(X2,function(x){ length(unique(x)) })

```


converting chr to integers

```{r}
X3 = X2 %>% mutate(term = as.numeric(term), int_rate = as.numeric(int_rate)/100, revol_util = as.numeric(revol_util)/100,
                          emp_length = str_extract(emp_length, "[0-9]{1,2}")) %>% mutate(emp_length = as.numeric(emp_length))
```

Converting categorical to factors

```{r}
cat = c("grade", "sub_grade", "home_ownership", "verification_status", "loan_status", "pymnt_plan")

X4        = mutate_at(X3,cat,as.factor)
```



